{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":["file:///home/nghiaphunng18/HustTutorial/ITSS.1.20251/lib/prisma.ts"],"sourcesContent":["import \"dotenv/config\";\nimport { PrismaPg } from '@prisma/adapter-pg'\nimport { PrismaClient } from '../prisma/generated/client';\n\nconst connectionString = `${process.env.POSTGRES_URL}`\n\nconst adapter = new PrismaPg({ connectionString })\nconst prisma = new PrismaClient({ adapter })\n\nexport { prisma }"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;AAEA,MAAM,mBAAmB,GAAG,QAAQ,GAAG,CAAC,YAAY,EAAE;AAEtD,MAAM,UAAU,IAAI,yKAAQ,CAAC;IAAE;AAAiB;AAChD,MAAM,SAAS,IAAI,wJAAY,CAAC;IAAE;AAAQ","debugId":null}},
    {"offset": {"line": 35, "column": 0}, "map": {"version":3,"sources":["file:///home/nghiaphunng18/HustTutorial/ITSS.1.20251/app/api/classes/%5Bid%5D/attendance-sessions/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\n\n// GET /api/classes/[id]/attendance-sessions - Get attendance sessions for a class\nexport async function GET(\n  req: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id: classId } = await params;\n    const { searchParams } = new URL(req.url);\n    const status = searchParams.get(\"status\");\n\n    const where: any = {\n      classId,\n    };\n\n    if (status) {\n      where.status = status;\n    }\n\n    const sessions = await prisma.attendanceSession.findMany({\n      where,\n      include: {\n        class: {\n          select: {\n            id: true,\n            name: true,\n            code: true,\n          },\n        },\n        checkIns: {\n          select: {\n            id: true,\n            studentId: true,\n            checkedAt: true,\n            student: {\n              select: {\n                id: true,\n                name: true,\n                studentCode: true,\n                avatar: true,\n              },\n            },\n          },\n          orderBy: {\n            checkedAt: \"asc\",\n          },\n        },\n      },\n      orderBy: {\n        createdAt: \"desc\",\n      },\n    });\n\n    return NextResponse.json(sessions);\n  } catch (error) {\n    console.error(\"Error fetching attendance sessions:\", error);\n    return NextResponse.json(\n      { error: \"Failed to fetch attendance sessions\" },\n      { status: 500 }\n    );\n  }\n}\n\n// POST /api/classes/[id]/attendance-sessions - Create a new attendance session\nexport async function POST(\n  req: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id: classId } = await params;\n    const body = await req.json();\n    const { title = \"Điểm danh\", createdById, durationMinutes = 10 } = body;\n\n    // Generate a 6-digit session code\n    const sessionCode = Math.floor(100000 + Math.random() * 900000).toString();\n    \n    // Generate a 6-digit password for attendance check-in\n    const password = Math.floor(100000 + Math.random() * 900000).toString();\n\n    // Calculate auto-close time based on duration\n    const endTime = new Date();\n    endTime.setMinutes(endTime.getMinutes() + durationMinutes);\n\n    const session = await prisma.attendanceSession.create({\n      data: {\n        classId,\n        title,\n        sessionCode,\n        password,\n        createdById: createdById || classId, // Fallback if createdById not provided\n        status: \"ACTIVE\",\n        endTime,\n      },\n      include: {\n        class: {\n          select: {\n            id: true,\n            name: true,\n            code: true,\n          },\n        },\n        checkIns: {\n          select: {\n            id: true,\n            studentId: true,\n            checkedAt: true,\n            student: {\n              select: {\n                id: true,\n                name: true,\n                studentCode: true,\n                avatar: true,\n              },\n            },\n          },\n        },\n      },\n    });\n\n    // Send notifications to all enrolled students\n    try {\n      const enrollments = await prisma.classEnrollment.findMany({\n        where: { classId },\n        select: { studentId: true },\n      });\n\n      // Find or create notification category\n      let category = await prisma.notificationCategory.findUnique({\n        where: { code: \"ATTENDANCE_STARTED\" },\n      });\n\n      if (!category) {\n        category = await prisma.notificationCategory.create({\n          data: {\n            code: \"ATTENDANCE_STARTED\",\n            name: \"Điểm danh bắt đầu\",\n            description: \"Thông báo khi giáo viên bắt đầu điểm danh\",\n            icon: \"FiUserCheck\",\n            color: \"mint\",\n            priority: \"HIGH\",\n          },\n        });\n      }\n\n      // Create notifications for all students\n      const notificationPromises = enrollments.map((enrollment) =>\n        prisma.notification.create({\n          data: {\n            userId: enrollment.studentId,\n            categoryId: category.id,\n            title: `Điểm danh: ${session.class.name}`,\n            message: `Giáo viên đã bắt đầu điểm danh. Mã: ${sessionCode}. Hạn chót: ${endTime.toLocaleTimeString(\n              \"vi-VN\",\n              { hour: \"2-digit\", minute: \"2-digit\" }\n            )}`,\n            link: `/dashboard/student/classes/${classId}?tab=attendance`,\n            priority: \"HIGH\",\n            metadata: {\n              sessionId: session.id,\n              classId,\n              sessionCode,\n              endTime: endTime.toISOString(),\n            },\n          },\n        })\n      );\n\n      await Promise.all(notificationPromises);\n    } catch (notifError) {\n      console.error(\"Failed to send notifications:\", notifError);\n      // Don't fail the whole request if notifications fail\n    }\n\n    return NextResponse.json(session, { status: 201 });\n  } catch (error) {\n    console.error(\"Error creating attendance session:\", error);\n    return NextResponse.json(\n      { error: \"Failed to create attendance session\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}